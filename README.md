# 电梯调度系统

## 项目简介

这是一个基于 LOOK 算法的电梯调度系统实现，包含完整的前后端架构，用于优化多电梯环境下的运行效率。该系统不仅实现了高效的电梯调度算法，还提供了实时可视化功能，让用户能够直观地观察电梯运行状态。系统的主要优化目标是最小化所有乘客的等待时间总和和 95% 乘客的等待时间总和。

## 系统架构

该项目采用前后端分离的架构设计，包含以下核心组件：

1. **前端可视化界面**：基于 HTML/CSS/JavaScript 实现的电梯运行状态可视化界面
2. **Flask 后端服务**：提供 RESTful API 接口，接收电梯状态数据并转发给前端
3. **电梯总线控制器**：负责收集电梯运行数据并发送到后端
4. **核心调度算法**：基于 LOOK 算法的电梯智能调度系统

![系统架构图](系统架构示意图)

## 核心功能

- **LOOK 算法实现**：电梯会在一个方向上持续移动，直到该方向上没有更多请求，然后改变方向
- **智能电梯分配**：基于电梯当前位置、运行方向、载客量和已有请求数量，为乘客分配最优电梯
- **动态方向控制**：根据实时请求情况，动态调整电梯运行方向
- **均匀初始分布**：系统初始化时，电梯会均匀分布到不同楼层，以提高响应效率
- **完整事件处理**：处理乘客呼叫、电梯停靠、乘客进出等多种事件
- **实时可视化展示**：通过 Web 界面直观展示电梯运行状态、乘客信息和事件日志

## 技术栈

- **后端**：Python 3.x, Flask, Flask-CORS
- **前端**：HTML5, CSS3, JavaScript
- **算法框架**：elevator_saga
- **数据传输**：HTTP RESTful API, JSON

## 文件结构

```
elevator_hw/
├── README.md                  # 项目说明文档
├── elevator_planner.py        # 基于LOOK算法的核心调度器实现
├── elevator_bus_modified.py   # 电梯总线控制器（带数据传输功能）
├── elevator_backend_flask.py  # Flask后端服务
└── elevator_frontend_html.html # 前端可视化界面
```

## 关键组件说明

### 1. 核心调度器 (ElevatorPlanner)

`elevator_planner.py` 实现了基于 LOOK 算法的电梯调度系统，主要功能包括：

- **初始化管理**：设置电梯初始位置和数据结构
- **智能电梯分配**：为乘客选择最佳电梯，考虑距离、方向、载客量等因素
- **动态目标更新**：根据请求情况实时调整电梯运行方向和目标楼层
- **事件回调处理**：响应各种电梯运行事件

#### 核心方法

- `on_init()`：系统初始化，设置电梯初始分布
- `on_passenger_call()`：处理乘客呼叫请求
- `_find_best_elevator_for_passenger()`：为乘客分配最佳电梯的核心算法
- `_update_elevator_target()`：更新电梯的目标楼层
- `_ensure_elevator_has_target()`：确保电梯始终有运行目标

### 2. 电梯总线控制器 (ElevatorBusExampleController)

`elevator_bus_modified.py` 扩展了基础电梯控制器，增加了数据传输功能：

- **数据收集**：收集电梯运行状态、事件日志和乘客信息
- **后端通信**：将数据实时发送到 Flask 后端服务
- **基础调度**：实现了简单的 BUS 调度算法

### 3. Flask 后端服务

`elevator_backend_flask.py` 提供了 RESTful API 接口：

- **状态更新接口**：接收电梯总线控制器发送的数据
- **数据获取接口**：向前端提供实时电梯状态数据
- **跨域支持**：使用 Flask-CORS 支持前端跨域请求
- **线程安全**：使用锁机制确保数据访问的线程安全

### 4. 前端可视化界面

`elevator_frontend_html.html` 实现了电梯运行状态的可视化展示：

- **电梯状态展示**：直观显示电梯位置、方向、载客量等信息
- **事件日志**：实时显示系统事件
- **乘客信息**：展示乘客的起始楼层和目标楼层
- **响应式设计**：适配不同屏幕尺寸

## 算法说明

### LOOK 算法

LOOK 算法是一种经典的磁盘调度算法的变种，适用于电梯调度场景：

1. 电梯在一个方向（上行或下行）上持续运行
2. 处理该方向上所有的请求
3. 当该方向没有更多请求时，改变方向
4. 重复上述过程

这种算法比简单的 FCFS（先来先服务）算法效率更高，能够减少电梯的往返次数，从而降低乘客的等待时间。

### 电梯分配策略

系统为乘客选择最佳电梯时，综合考虑以下因素：

- **距离因素**：电梯到乘客所在楼层的距离越近越好
- **方向因素**：优先选择与乘客请求方向相同的电梯
- **载客量因素**：优先选择载客量较少的电梯
- **请求数量因素**：优先选择当前请求数量较少的电梯

系统通过加权计算综合得分，选择得分最低的电梯为乘客服务：

```python
score = distance * direction_factor + elevator.load_factor * 10 + request_count * 0.5
```

## 部署与运行指南

### 前提条件

- Python 3.10 环境
- Conda 环境管理器（用于批处理文件自动创建虚拟环境）
- 安装所需依赖：`pip install flask flask-cors requests elevator_saga`

### 自动部署方式（推荐）

项目提供了批处理文件，用于自动创建虚拟环境、安装依赖并启动整个系统：
```bash
start_elevator_system.bat
```

这些批处理文件将自动执行以下操作：
- 创建名为 `elevator` 的 conda 虚拟环境
- 安装项目所需的所有依赖包
- 依次启动 elevator_saga 服务器、Flask 后端服务和电梯调度器
- 自动打开前端 HTML 界面

### 手动部署方式

1. **启动后端服务**：
   ```bash
   python elevator_backend_flask.py
   ```

2. **启动 elevator_saga 服务器**：
   ```bash
   python -m elevator_saga.server.simulator
   ```

3. **启动电梯控制器**（二选一）：
   - 使用 LOOK 算法调度器：
     ```bash
     python elevator_planner.py
     ```
   - 或使用带数据传输功能的总线控制器：
     ```bash
     python elevator_bus_modified.py
     ```

4. **打开前端界面**：
   直接在浏览器中打开 `elevator_frontend_html.html` 文件

### 调试模式

默认情况下，系统启用调试模式，可以在控制台查看电梯运行的详细日志。如需关闭调试模式，可修改相应文件中的参数：

```python
# 在 elevator_planner.py 中
elevator_planner = ElevatorPlanner(debug=False)

# 在 elevator_bus_modified.py 中
algorithm = ElevatorBusExampleController()
```

## 优化目标

该系统的主要优化目标是：

1. **最小化所有乘客的等待时间总和**：通过智能调度减少整体等待时间
2. **最小化 95% 乘客的等待时间总和**：确保大多数乘客的良好体验
3. **提高电梯运行效率**：减少电梯空驶率和无效移动

通过 LOOK 算法和智能电梯分配策略，系统能够在高负载情况下保持较好的性能表现。

## 扩展与改进方向

1. **预测性调度**：考虑楼层客流量的历史数据，进行预测性调度
2. **分区服务**：实现更复杂的电梯分组策略，如分区服务
3. **故障检测与恢复**：添加故障检测和恢复机制
4. **高峰期优化**：优化高峰期的调度策略，应对突发客流
5. **数据持久化**：添加数据库支持，存储运行数据用于分析
6. **用户定制化**：提供配置界面，允许用户调整算法参数
7. **移动应用**：开发移动应用，方便远程监控电梯状态

## 开发说明

### 代码风格

项目采用 PEP 8 代码风格规范，使用四个空格进行缩进，函数和类采用清晰的命名方式，并提供详细的文档字符串。

### 依赖管理

项目的依赖信息存储在 `requirements.txt` 文件中，包含以下主要依赖：

- Flask >= 2.0.0
- Flask-CORS >= 3.0.0
- requests >= 2.0.0
- elevator_saga >= 0.1.0

### 测试方法

目前可以通过以下方式测试系统功能：

1. 启动完整系统后，观察电梯响应乘客请求的情况
2. 在高负载情况下测试系统性能
3. 检查日志输出，确保各组件正常工作
