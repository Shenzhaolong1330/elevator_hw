# 智能电梯调度系统 - 二阶段

## 项目概述

本项目是一个智能电梯调度系统，支持**GUI可视化**和**算法控制**分离的架构设计。可以独立运行GUI或算法，也可以将本组的GUI对接其他组的算法，或将本组算法对接其他组的GUI。

### 核心特性

- 🎨 **现代化GUI界面**：采用PyQt6开发，扁平化设计风格，实时动画效果
- 🧠 **智能调度算法**：基于SCAN算法的电梯调度，支持分区服务和负载均衡
- 🔌 **模块化架构**：GUI和算法完全解耦，支持跨组对接
- 📊 **实时监控**：电梯状态、呼叫信号、运行统计一目了然
- ⚡ **能耗统计**：自动记录电梯移动次数和总能耗

---

## 文件结构

```
/repo_root
├── gui.py                  # 原始GUI组件库
├── gui_only.py            # 纯GUI模式（只显示不控制）
├── algorithm_only.py      # 纯算法模式（只控制不显示）
├── start.bat              # Windows启动脚本（GUI模式）
├── start.sh               # Linux启动脚本（GUI模式）
├── start_no_gui.bat       # Windows无头模式（纯算法）
├── start_no_gui.sh        # Linux无头模式（纯算法）
└── README.md              # 本文档
```

---

## 运行依赖

### 系统要求
- **Python**: 3.8 或更高版本
- **操作系统**: Windows 10/11, Linux, macOS

### Python包依赖
- `elevator-py`: 电梯模拟器核心库
- `PyQt6`: GUI界面库（仅GUI模式需要）

**依赖会在启动脚本中自动安装，无需手动安装**

---

## 使用说明

### 1️⃣ GUI模式（默认）

**适用场景**：启动可视化界面，配合其他组的算法使用

#### Windows:
```bash
start.bat
```

#### Linux/macOS:
```bash
chmod +x start.sh
./start.sh
```

**操作步骤**：
1. 运行启动脚本，等待GUI窗口出现
2. 点击 "▶ 启动" 按钮
3. 等待其他组的算法连接到服务器
4. 观察电梯运行可视化效果

---

### 2️⃣ 无头模式（纯算法）

**适用场景**：只运行算法逻辑，配合其他组的GUI使用

#### Windows:
```bash
start_no_gui.bat
```

#### Linux/macOS:
```bash
chmod +x start_no_gui.sh
./start_no_gui.sh
```

**操作步骤**：
1. 先启动其他组的GUI
2. 运行本脚本
3. 算法将自动连接到服务器并开始控制电梯

---

### 3️⃣ 跨组对接

#### 场景A：使用本组GUI + 其他组算法

1. **启动本组GUI**:
   ```bash
   # 先设置环境变量
   set ELEVATOR_CLIENT_TYPE=gui    # Windows
   export ELEVATOR_CLIENT_TYPE=gui # Linux
   
   # 启动GUI
   python gui_only.py
   ```

2. **等待GUI启动完成后，启动其他组的算法**:
   ```bash
   # 在其他组的仓库中
   set ELEVATOR_CLIENT_TYPE=algorithm    # Windows
   export ELEVATOR_CLIENT_TYPE=algorithm # Linux
   
   # 运行他们的算法
   python their_algorithm.py
   ```

#### 场景B：使用本组算法 + 其他组GUI

1. **先启动其他组的GUI**

2. **启动本组算法**:
   ```bash
   start_no_gui.bat  # Windows
   ./start_no_gui.sh # Linux
   ```

---

## 设计概要

### 架构设计

本系统采用**客户端-服务器**架构，通过`elevator-py`模拟器作为服务器，GUI和算法作为独立客户端：

```
┌─────────────────────┐
│  Elevator Server    │
│  (elevator-py)      │
└──────────┬──────────┘
           │
    ┌──────┴───────┐
    │              │
┌───▼────┐    ┌───▼────┐
│  GUI   │    │Algorithm│
│ Client │    │ Client │
└────────┘    └─────────┘
```

### 环境变量控制

通过 `ELEVATOR_CLIENT_TYPE` 环境变量区分运行模式：

- **`gui`**: 只接收事件用于显示，不发送控制指令
- **`algorithm`**: 正常控制电梯，可以调用 `go_to_floor` 等方法

### GUI模式特点

**GUIOnlyController**类：
- ✅ 接收所有事件（`on_passenger_call`, `on_elevator_move` 等）
- ✅ 更新界面显示
- ✅ 记录统计数据
- ❌ **不调用** `go_to_floor()` 等控制方法
- ❌ 不进行任务分配和调度决策

### 算法模式特点

**IntelligentDispatchController**类：
- ✅ 接收所有事件
- ✅ **调用** `go_to_floor()` 控制电梯
- ✅ 智能派梯和任务调度
- ✅ 能耗统计（1-3号电梯：1/次，4号电梯：2/次）
- ❌ 无GUI显示

---

## 核心算法说明

### 智能派梯算法

采用**评分制**选择最优电梯：

1. **空闲电梯评分**：
   - 基础分 = 100 - 距离 × 2
   - 在服务区域内 +50分

2. **运行中电梯评分**：
   - 同方向且顺路：80 - 距离
   - 根据负载率调整：分数 × (1 - 负载率 × 0.5)

### SCAN调度算法

类似磁盘调度的SCAN算法：
- 继续当前方向直到无目标
- 到达端点后反向服务
- 减少频繁换向，提高效率

### 分区服务策略

- 将楼层划分为N个区域（N=电梯数量）
- 每台电梯负责一个主要区域
- 区域外呼叫作为次要任务

---

## 能耗计算规则

根据二阶段要求：
- **1-3号电梯**：每次移动能耗 = 1
- **4号电梯**：每次移动能耗 = 2
- 总能耗 = Σ(每台电梯移动次数 × 能耗系数)

---

## 测试案例

系统已针对以下场景优化：

1. ✅ **低峰时段**：少量分散呼叫
2. ✅ **高峰时段**：大量集中呼叫（上班/下班）
3. ✅ **典型工作日**：混合场景，4台电梯运行
4. ✅ **长时间运行**：稳定性测试

---

## 评测指标

### 主要指标
- **总能耗**：所有电梯移动次数加权和
- **平均等待时间**：从呼叫到登梯的平均时间

### 次要指标
- GUI正常运行
- 跨组对接成功数量

---

## 常见问题

### Q1: 提示找不到elevator-py？
**A**: 启动脚本会自动安装依赖。如手动安装失败，请使用镜像源：
```bash
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple/ elevator-py PyQt6
```

### Q2: GUI启动失败？
**A**: 确保安装了PyQt6，并检查系统是否支持图形界面：
```bash
python -c "from PyQt6.QtWidgets import QApplication"
```

### Q3: 如何确认跨组对接成功？
**A**: 
- GUI模式：能看到电梯运行动画，日志显示"新呼叫"等信息
- 算法模式：控制台输出"分配电梯X响应"等调度信息

### Q4: 两个客户端如何通信？
**A**: 通过elevator-py服务器中转，不需要直接通信。服务器会将事件广播给所有客户端。

### Q5: 可以同时运行多个GUI吗？
**A**: 可以，但只有一个算法客户端应该有控制权（`ELEVATOR_CLIENT_TYPE=algorithm`），其他都应该是`gui`模式。

---

## 技术支持

如遇到问题，请检查：
1. Python版本是否 >= 3.8
2. 依赖包是否正确安装
3. 环境变量是否正确设置
4. 服务器是否正常运行（elevator-py会自动启动）

---

## 更新日志

### v2.0 (二阶段)
- ✨ 新增GUI/算法分离架构
- ✨ 支持跨组对接
- ✨ 新增能耗统计功能
- ✨ 优化SCAN调度算法
- ✨ 完善启动脚本

### v1.0 (一阶段)
- 🎉 初始版本
- 基础GUI界面
- 智能派梯算法

---

## 开发者信息

**项目**：智能电梯调度系统  
**阶段**：二阶段  
**截止时间**：2025.10.25 晚8点  

---

## 许可证

本项目仅用于课程作业，未经许可不得用于商业用途。